---
import { getCollection } from 'astro:content';
import { TAGS } from '../../content/config';
import type { Tag } from '../../content/config';

export async function getStaticPaths() {
  return TAGS.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

if (!tag) {
  throw new Error('Tag param is missing');
}

const typedTag = tag as Tag;

// 全記事取得
const allPosts = await getCollection('posts');

// タグでフィルタ
const taggedPosts = allPosts.filter((post) =>
  post.data.tags?.includes(typedTag)
);

// 新しい順にソート
taggedPosts.sort(
  (a, b) =>
    b.data.published_date.getTime() -
    a.data.published_date.getTime()
);
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Tag: {tag}</title>
  </head>

  <body>
    <main>
      <h1>Tag: {tag}</h1>

      {taggedPosts.length === 0 ? (
        <p>このタグの記事はまだありません。</p>
      ) : (
        <ul>
          {taggedPosts.map((post) => (
            <li>
              <a href={`/posts/${post.slug}`}>
                <time datetime={post.data.published_date.toISOString()}>
                  {post.data.published_date.toISOString().slice(0, 10)}
                </time>
                {' '}
                {post.data.title}
              </a>
            </li>
          ))}
        </ul>
      )}
    </main>
  </body>
</html>
